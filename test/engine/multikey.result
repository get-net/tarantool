test_run = require('test_run').new()
---
...
engine = test_run:get_cfg('engine')
---
...
--
-- gh-1260: Multikey indexes
--
s = box.schema.space.create('withdata', {engine = 'vinyl'})
---
...
pk = s:create_index('pk')
---
...
-- Vinyl's space can't be multikey (yet).
_ = s:create_index('idx', {parts = {{3, 'str', path = '[*].fname'}, {3, 'str', path = '[*].sname'}}})
---
- error: Vinyl does not support multikey indexes
...
s:drop()
---
...
s = box.schema.space.create('withdata', {engine = 'memtx'})
---
...
-- Primary index must be unique so it can't be multikey.
_ = s:create_index('idx', {parts = {{3, 'str', path = '[*].fname'}}})
---
- error: 'Can''t create or modify index ''idx'' in space ''withdata'': primary key
    cannot be multikey'
...
pk = s:create_index('pk')
---
...
-- Only tree index type may be mutlikey.
_ = s:create_index('idx', {type = 'hash', unique = true, parts = {{3, 'str', path = '[*].fname'}}})
---
- error: 'Can''t create or modify index ''idx'' in space ''withdata'': HASH index
    cannot be multikey'
...
_ = s:create_index('idx', {type = 'bitset', unique = false, parts = {{3, 'str', path = '[*].fname'}}})
---
- error: 'Can''t create or modify index ''idx'' in space ''withdata'': BITSET index
    cannot be multikey'
...
_ = s:create_index('idx', {type = 'rtree', unique = false, parts = {{3, 'array', path = '[*].fname'}}})
---
- error: 'Can''t create or modify index ''idx'' in space ''withdata'': RTREE index
    cannot be multikey'
...
-- Test incompatible multikey index parts.
_ = s:create_index('idx3', {parts = {{3, 'str', path = '[*].fname'}, {3, 'str', path = '["data"][*].sname'}}})
---
- error: 'Wrong index options (field 2): incompatable multikey index path'
...
_ = s:create_index('idx2', {parts = {{3, 'str', path = '[*].fname'}, {3, 'str', path = '[*].sname[*].a'}}})
---
- error: 'Multikey index is invalid: no more than one array index placeholder [*]
    is allowed in JSON path'
...
idx0 = s:create_index('idx0', {parts = {{3, 'str', path = '[1].fname'}}})
---
...
_ = s:create_index('idx', {parts = {{3, 'str', path = '[*].fname'}, {3, 'str', path = '[*].sname'}}})
---
- error: 'Multikey index is invalid: field 3 is already refer to document by identifier
    and cannot use array index placeholder [*]'
...
idx0:drop()
---
...
-- Unique multikey index.
idx = s:create_index('idx', {unique = true, parts = {{3, 'str', path = '[*].fname'}, {3, 'str', path = '[*].sname'}}})
---
...
_ = s:create_index('idx2', {parts = {{3, 'str', path = '[1].fname'}, {3, 'str', path = '[1].sname'}}})
---
- error: 'Multikey index is invalid: field 3 is already used with array index placeholder
    [*] and cannot refer to document by identifier'
...
s:insert({1, {1, 2, 3}, {{fname='James', sname='Bond'}, {fname='Vasya', sname='Pupkin'}}})
---
- [1, [1, 2, 3], [{'fname': 'James', 'sname': 'Bond'}, {'fname': 'Vasya', 'sname': 'Pupkin'}]]
...
s:insert({2, {3, 4, 5}, {{fname='Ivan', sname='Ivanych'}}})
---
- [2, [3, 4, 5], [{'fname': 'Ivan', 'sname': 'Ivanych'}]]
...
_ = s:create_index('arr_idx', {unique = true, parts = {{2, 'unsigned', path = '[*]'}}})
---
- error: Duplicate key exists in unique index 'arr_idx' in space 'withdata'
...
-- Non-unique multikey index; two multikey indexes per space.
arr_idx = s:create_index('arr_idx', {unique = false, parts = {{2, 'unsigned', path = '[*]'}}})
---
...
arr_idx:select()
---
- - [1, [1, 2, 3], [{'fname': 'James', 'sname': 'Bond'}, {'fname': 'Vasya', 'sname': 'Pupkin'}]]
  - [1, [1, 2, 3], [{'fname': 'James', 'sname': 'Bond'}, {'fname': 'Vasya', 'sname': 'Pupkin'}]]
  - [1, [1, 2, 3], [{'fname': 'James', 'sname': 'Bond'}, {'fname': 'Vasya', 'sname': 'Pupkin'}]]
  - [2, [3, 4, 5], [{'fname': 'Ivan', 'sname': 'Ivanych'}]]
  - [2, [3, 4, 5], [{'fname': 'Ivan', 'sname': 'Ivanych'}]]
  - [2, [3, 4, 5], [{'fname': 'Ivan', 'sname': 'Ivanych'}]]
...
idx:get({'James', 'Bond'})
---
- [1, [1, 2, 3], [{'fname': 'James', 'sname': 'Bond'}, {'fname': 'Vasya', 'sname': 'Pupkin'}]]
...
idx:get({'Ivan', 'Ivanych'})
---
- [2, [3, 4, 5], [{'fname': 'Ivan', 'sname': 'Ivanych'}]]
...
idx:get({'Vasya', 'Pupkin'})
---
- [1, [1, 2, 3], [{'fname': 'James', 'sname': 'Bond'}, {'fname': 'Vasya', 'sname': 'Pupkin'}]]
...
idx:select()
---
- - [2, [3, 4, 5], [{'fname': 'Ivan', 'sname': 'Ivanych'}]]
  - [1, [1, 2, 3], [{'fname': 'James', 'sname': 'Bond'}, {'fname': 'Vasya', 'sname': 'Pupkin'}]]
  - [1, [1, 2, 3], [{'fname': 'James', 'sname': 'Bond'}, {'fname': 'Vasya', 'sname': 'Pupkin'}]]
...
s:insert({3, {1, 2}, {{fname='Vasya', sname='Pupkin'}}})
---
- error: Duplicate key exists in unique index 'idx' in space 'withdata'
...
s:insert({4, {1}, {{fname='James', sname='Bond'}}})
---
- error: Duplicate key exists in unique index 'idx' in space 'withdata'
...
idx:select()
---
- - [2, [3, 4, 5], [{'fname': 'Ivan', 'sname': 'Ivanych'}]]
  - [1, [1, 2, 3], [{'fname': 'James', 'sname': 'Bond'}, {'fname': 'Vasya', 'sname': 'Pupkin'}]]
  - [1, [1, 2, 3], [{'fname': 'James', 'sname': 'Bond'}, {'fname': 'Vasya', 'sname': 'Pupkin'}]]
...
-- Duplicates in multikey parts.
s:insert({5, {1, 1, 1}, {{fname='A', sname='B'}, {fname='C', sname='D'}, {fname='A', sname='B'}}})
---
- [5, [1, 1, 1], [{'fname': 'A', 'sname': 'B'}, {'fname': 'C', 'sname': 'D'}, {'fname': 'A',
      'sname': 'B'}]]
...
arr_idx:select({1})
---
- - [1, [1, 2, 3], [{'fname': 'James', 'sname': 'Bond'}, {'fname': 'Vasya', 'sname': 'Pupkin'}]]
  - [5, [1, 1, 1], [{'fname': 'A', 'sname': 'B'}, {'fname': 'C', 'sname': 'D'}, {
        'fname': 'A', 'sname': 'B'}]]
...
s:delete(5)
---
- [5, [1, 1, 1], [{'fname': 'A', 'sname': 'B'}, {'fname': 'C', 'sname': 'D'}, {'fname': 'A',
      'sname': 'B'}]]
...
-- Check that there is no garbage in index
arr_idx:select({1})
---
- - [1, [1, 2, 3], [{'fname': 'James', 'sname': 'Bond'}, {'fname': 'Vasya', 'sname': 'Pupkin'}]]
...
idx:get({'A', 'B'})
---
...
idx:get({'C', 'D'})
---
...
idx:delete({'Vasya', 'Pupkin'})
---
- [1, [1, 2, 3], [{'fname': 'James', 'sname': 'Bond'}, {'fname': 'Vasya', 'sname': 'Pupkin'}]]
...
s:insert({6, {1, 2}, {{fname='Vasya', sname='Pupkin'}}})
---
- [6, [1, 2], [{'fname': 'Vasya', 'sname': 'Pupkin'}]]
...
s:insert({7, {1}, {{fname='James', sname='Bond'}}})
---
- [7, [1], [{'fname': 'James', 'sname': 'Bond'}]]
...
arr_idx:select({1})
---
- - [6, [1, 2], [{'fname': 'Vasya', 'sname': 'Pupkin'}]]
  - [7, [1], [{'fname': 'James', 'sname': 'Bond'}]]
...
idx:select()
---
- - [2, [3, 4, 5], [{'fname': 'Ivan', 'sname': 'Ivanych'}]]
  - [7, [1], [{'fname': 'James', 'sname': 'Bond'}]]
  - [6, [1, 2], [{'fname': 'Vasya', 'sname': 'Pupkin'}]]
...
-- Snapshot & recovery.
box.snapshot()
---
- ok
...
test_run:cmd("restart server default")
s = box.space["withdata"]
---
...
idx = s.index["idx"]
---
...
arr_idx = s.index["arr_idx"]
---
...
s:select()
---
- - [2, [3, 4, 5], [{'fname': 'Ivan', 'sname': 'Ivanych'}]]
  - [6, [1, 2], [{'fname': 'Vasya', 'sname': 'Pupkin'}]]
  - [7, [1], [{'fname': 'James', 'sname': 'Bond'}]]
...
idx:select()
---
- - [2, [3, 4, 5], [{'fname': 'Ivan', 'sname': 'Ivanych'}]]
  - [7, [1], [{'fname': 'James', 'sname': 'Bond'}]]
  - [6, [1, 2], [{'fname': 'Vasya', 'sname': 'Pupkin'}]]
...
arr_idx:select()
---
- - [6, [1, 2], [{'fname': 'Vasya', 'sname': 'Pupkin'}]]
  - [7, [1], [{'fname': 'James', 'sname': 'Bond'}]]
  - [6, [1, 2], [{'fname': 'Vasya', 'sname': 'Pupkin'}]]
  - [2, [3, 4, 5], [{'fname': 'Ivan', 'sname': 'Ivanych'}]]
  - [2, [3, 4, 5], [{'fname': 'Ivan', 'sname': 'Ivanych'}]]
  - [2, [3, 4, 5], [{'fname': 'Ivan', 'sname': 'Ivanych'}]]
...
s:drop()
---
...
-- Assymetric multikey index paths.
s = box.schema.space.create('withdata')
---
...
pk = s:create_index('pk')
---
...
idx = s:create_index('idx', {parts = {{3, 'str', path = '[*].fname'}, {3, 'str', path = '[*].extra.sname', is_nullable = true}}})
---
...
s:insert({1, 1, {{fname='A1', extra={sname='A2'}}, {fname='B1'}, {fname='C1', extra={sname='C2'}}}})
---
- [1, 1, [{'fname': 'A1', 'extra': {'sname': 'A2'}}, {'fname': 'B1'}, {'fname': 'C1',
      'extra': {'sname': 'C2'}}]]
...
s:drop()
---
...
-- Unique multikey index peculiar properties
s = box.schema.space.create('withdata')
---
...
pk = s:create_index('pk')
---
...
idx0 = s:create_index('idx0', {parts = {{2, 'int', path = '[*]'}}})
---
...
s:insert({1, {1, 1, 1}})
---
- [1, [1, 1, 1]]
...
s:insert({2, {2, 2}})
---
- [2, [2, 2]]
...
s:insert({3, {3, 3, 2, 2, 1, 1}})
---
- error: Duplicate key exists in unique index 'idx0' in space 'withdata'
...
idx0:get(2)
---
- [2, [2, 2]]
...
idx0:get(1)
---
- [1, [1, 1, 1]]
...
idx0:get(3)
---
...
idx0:select()
---
- - [1, [1, 1, 1]]
  - [2, [2, 2]]
...
idx0:delete(2)
---
- [2, [2, 2]]
...
idx0:get(2)
---
...
idx0:select()
---
- - [1, [1, 1, 1]]
...
s:drop()
---
...
